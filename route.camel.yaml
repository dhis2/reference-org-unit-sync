# camel-k: dependency=mvn:org.apache.activemq:artemis-jakarta-server:2.38.0

- route:
    from:
      uri: debezium-postgres:dhis2
      parameters:
        databaseHostname: "{{dhis2DatabaseHostname}}"
        databasePort: "{{dhis2DatabasePort}}"
        databaseUser: "{{dhis2DatabaseUser}}"
        databasePassword: "{{dhis2DatabasePassword}}"
        databaseDbname: "{{dhis2DatabaseDbname}}"
        offsetStorageFileName: offset.dat
        topicPrefix: prefix1
        pluginName: pgoutput
        tableIncludeList: public.organisationunit
        columnIncludeList: ".*\\.uid"
        schemaIncludeList: public
        slotName: slot1
      steps:
        - log:
            loggingLevel: INFO
            message: "Syncing org unit [${body.get('uid')}]..."
        - toD:
            uri: dhis2:get/resource
            parameters:
              path: "organisationUnits/${body.get('uid')}"
              fields: "*"
              username: admin
              password: district
              baseApiUrl: "{{sourceDhis2ApiUrl}}"
        - to: jms:queue:orgUnits

- route:
    from:
      uri: jms:queue:orgUnits
      steps:
        - setBody:
            groovy: request.getBody(String.class)
        - toD:
            uri: dhis2:post/resource
            parameters:
              path: organisationUnits
              username: admin
              password: district
              baseApiUrl: "{{targetDhis2ApiUrl}}"
        - unmarshal:
            json: { }
        - choice:
            when:
              - simple: "${body['status']} == 'SUCCESS' || ${body['status']}  == 'OK'"
                steps:
                  - log:
                      message: "Successfully synced org unit [${body['response']['uid']}]"
                      loggingLevel: INFO
            otherwise:
              steps:
                - log:
                    message: "Unexpected status code when updating the dhis program stage event status for event with ID\
                      \ => ${exchangeProperty.eventPayload['event']}. HTTP ${header.CamelHttpResponseCode}. HTTP response\
                      \ body => ${body}"
                    loggingLevel: ERROR

