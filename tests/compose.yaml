networks:
  sourceDb:
  targetDb:
  anotherTargetDb:

services:
  sourceDb:
    image: postgis/postgis:13-3.4-alpine
    ports:
      - "5432:5432"
    command: postgres -c config_file=/etc/postgresql.conf
    volumes:
      - ./postgres/postgresql.conf:/etc/postgresql.conf
    environment:
      - POSTGRES_USER=dhis
      - POSTGRES_PASSWORD=dhis
      - POSTGRES_DB=dhis2
    healthcheck:
      test: [ "CMD-SHELL", "psql --no-password --quiet --username $$POSTGRES_USER postgres://127.0.0.1/$$POSTGRES_DB -p 5432 --command \"SELECT 'ok'\" > /dev/null" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - sourceDb

  targetDb:
    image: postgis/postgis:13-3.4-alpine
    ports:
      - "5432"
    environment:
      - POSTGRES_USER=dhis
      - POSTGRES_PASSWORD=dhis
      - POSTGRES_DB=dhis2
    healthcheck:
      test: [ "CMD-SHELL", "psql --no-password --quiet --username $$POSTGRES_USER postgres://127.0.0.1/$$POSTGRES_DB -p 5432 --command \"SELECT 'ok'\" > /dev/null" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - targetDb

  anotherTargetDb:
    image: postgis/postgis:13-3.4-alpine
    ports:
      - "5432"
    environment:
      - POSTGRES_USER=dhis
      - POSTGRES_PASSWORD=dhis
      - POSTGRES_DB=dhis2
    healthcheck:
      test: [ "CMD-SHELL", "psql --no-password --quiet --username $$POSTGRES_USER postgres://127.0.0.1/$$POSTGRES_DB -p 5432 --command \"SELECT 'ok'\" > /dev/null" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - anotherTargetDb

  sourceDhis2:
    image: "dhis2/core:40.5.0"
    ports:
      - "8080:8080"
    restart: unless-stopped
    volumes:
      - ./dhis2/sourceDhis.conf:/opt/dhis2/dhis.conf:ro
    depends_on:
      sourceDb:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -S -O /dev/null http://127.0.0.1:8080/dhis-web-commons/security/login.action 2>&1| grep -q 'HTTP.*200'" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - sourceDb

  configureTableReplication:
    image: alpine/psql:17.4
    entrypoint: sh
    command: >
      -c "/usr/bin/psql postgres://dhis:dhis@sourceDb:5432/dhis2
      -c 'ALTER TABLE public.organisationunit REPLICA IDENTITY FULL'
      -c 'DROP USER IF EXISTS orgunitsyncapp'
      -c \"CREATE USER orgunitsyncapp WITH REPLICATION PASSWORD 'dhis'\" 
      -c 'DROP PUBLICATION IF EXISTS dbz_publication'
      -c 'CREATE PUBLICATION dbz_publication FOR TABLE organisationunit, orgunitgroup, orgunitgroupset' && tail -f /dev/null"
    depends_on:
      sourceDhis2:
        condition: service_healthy
    networks:
      - sourceDb

  targetDhis2:
    image: "dhis2/core:40.5.0"
    ports:
      - "8081:8080"
    restart: unless-stopped
    volumes:
      - ./dhis2/targetDhis.conf:/opt/dhis2/dhis.conf:ro
    depends_on:
      targetDb:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -S -O /dev/null http://127.0.0.1:8080/dhis-web-commons/security/login.action 2>&1| grep -q 'HTTP.*200'" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - targetDb

  anotherTargetDhis2:
    image: "dhis2/core:40.5.0"
    ports:
      - "8082:8080"
    restart: unless-stopped
    volumes:
      - ./dhis2/anotherTargetDhis.conf:/opt/dhis2/dhis.conf:ro
    depends_on:
      targetDb:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "wget -q -S -O /dev/null http://127.0.0.1:8080/dhis-web-commons/security/login.action 2>&1| grep -q 'HTTP.*200'" ]
      start_period: 120s
      interval: 30s
      timeout: 5s
      retries: 5
    networks:
      - anotherTargetDb