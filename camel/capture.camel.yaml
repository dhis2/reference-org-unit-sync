- route:
    id: captureChangeRoute
    description: Listens for org unit changes in the source DHIS2 database.
    from:
      description: |
        Captures all database row changes applied to the tables `organisationunit`, `orgunitgroup`, and `orgunitgroupset`.
        This table list can be customised to exclude or include other tables (e.g., `users`) by setting the 
        `source.tableIncludeList` application property.
      uri: debezium-postgres:dhis2
      parameters:
        databaseHostname: "{{source.dhis2DatabaseHostname}}"
        databasePort: "{{source.dhis2DatabasePort}}"
        databaseUser: "{{source.dhis2DatabaseUser}}"
        databasePassword: "{{source.dhis2DatabasePassword}}"
        databaseDbname: "{{source.dhis2DatabaseDbName}}"
        offsetStorageFileName: "{{source.offsetStorageFileName:data/offset.dat}}"
        topicPrefix: dhis2
        pluginName: pgoutput
        tableIncludeList: "{{source.tableIncludeList:public.organisationunit,public.orgunitgroup,public.orgunitgroupset}}"
        columnIncludeList: ".*"
        schemaIncludeList: "{{source.schemaIncludeList:public}}"
        slotName: "{{source.slotName:slot1}}"
        snapshotMode: "{{source.snapshotMode:no_data}}"
        publicationAutocreateMode: "{{source.publicationAutocreateMode:disabled}}"
        publicationName: "{{source.publicationName:dbz_publication}}"
      steps:
        - log: "Capturing database change [${headers}]..."
        - setHeader:
            description: |
              Copies the header while omitting the reserved `Camel` prefix from the new header name so that the header 
              is added to the JMS message.
            name: DebeziumOperation
            header: CamelDebeziumOperation
        - setHeader:
            description: |
              TODO
            name: DebeziumSourceTable
            simple: ${headers.CamelDebeziumSourceMetadata['table']}
        - setHeader:
            description: Records the changed columns.
            name: DebeziumDiff
            groovy: |
              (headers.CamelDebeziumBefore?.schema()?.fields() ?: body.schema().fields())
                .findAll { headers.CamelDebeziumBefore?.get(it) != (body?.get(it) ?: true) }
                .collect { headers.DebeziumSourceTable + '.' + it.name() }.join(',')
        - setBody:
            description: |
              Falls back to the pre-commit row UID in case the post-commit row UID does not exist. Typically this means 
              that the row was deleted.
            groovy: "body?.get('uid') ?: headers.CamelDebeziumBefore.get('uid')"
        - to: jms:queue:delta/sync/1