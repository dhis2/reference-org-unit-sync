# fetches the changed organisation unit group set from the DHIS2 Web API
- route:
    id: syncOrgUnitGroupSetRoute
    routeConfigurationId: deadLetterQueueRouteConfig
    logMask: true
    from:
      uri: direct:syncOrgUnitGroupSet
      steps:
        - setVariable:
            name: id
            simple: ${body}
        - toD:
            uri: dhis2:get/resource
            parameters:
              path: organisationUnitGroupSets/${variables.id}
              fields: "*"
              baseApiUrl: ${properties:source.dhis2ApiUrl}
              username: ${properties:source.dhis2ApiUsername:}
              password: ${properties:source.dhis2ApiPassword:}
              personalAccessToken: ${properties:source.dhis2ApiPersonalAccessToken:}
        - unmarshal:
            json: { }
        - setVariable:
            name: orgUnitGroupSet
            simple: ${body}
        - log:
            loggingLevel: INFO
            message: "Syncing create/update for org unit group set [${variables.id}]..."
        - split:
            shareUnitOfWork: true
            method:
              beanType: "TargetsSplitter"
              method: "split"
            steps:
              - setVariable:
                  name: target
                  simple: ${body}
              - transform:
                  datasonnet:
                    outputMediaType: application/x-java-object
                    resultType: java.util.Map
                    bodyMediaType: application/x-java-object
                    expression: resource:classpath:datasonnet/orgUnitGroupSet.ds
              - toD: ${variables.target['endpointUri']}
