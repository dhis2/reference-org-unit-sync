# replace this bare-bones approval workflow with your own workflow solution

- dataFormats:
    - crypto:
        keyRef: secretKey
        cryptoProvider: "BC"
        algorithm: AES
        id: cryptoDataFormat

- route:
    id: acceptApprovedSyncRoute
    description: Listens for HTTP requests that approve synchronisations, and pushes them onto a queue.
    from:
      description: Accepts GET HTTP requests with the `/approve` URL path.
      uri: "platform-http:/approve"
      parameters:
        httpMethodRestrict: GET
      steps:
        - to:
            description: Decrypts the query parameters.
            uri: direct:decryptQueryParams
        - to:
            description: Pushes the decrypted query params headers to a queue without waiting for an async response.
            uri: jms:queue:approvals
            parameters:
              exchangePattern: InOnly
        - setBody:
            description: Sets the HTTP response body.
            constant: Processing...

- route:
    id: syncApprovedRoute
    description: Dequeues the decrypted query params headers and resolves target references before completing the synchronisation.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      description: Dequeues the decrypted query params.
      uri: jms:queue:approvals
      parameters:
        transacted: true
        maxConcurrentConsumers: 1
      steps:
        - setVariable:
            description: Sets the variable `id` to the metadata resource ID received in the query param.
            name: id
            simple: ${headers.resourceId}
        - setVariable:
            description: Reconstructs all the parameters required for synchronisation.
            name: target
            groovy: |
              [
                'dhis2ApiUrl': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.dhis2ApiUrl').get(),
                'dhis2ApiUsername': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.dhis2ApiUsername').orElse(null),
                'dhis2ApiPassword': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.dhis2ApiPassword').orElse(null),
                'dhis2ApiPersonalAccessToken': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.dhis2ApiPersonalAccessToken').orElse(null),
                'idScheme': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.idScheme').orElse(TargetRouteTemplateParameterSource.IMPORT_UID_SCHEME),
                'camelDirectEndpointName': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.camelDirectEndpointName').orElse(TargetRouteTemplateParameterSource.DHIS2_DIRECT_ENDPOINT_NAME),
                'messageConversationUserId': camelContext.propertiesComponent.resolveProperty('target.' + headers.targetIndex + '.messageConversationUserId').orElse(TargetRouteTemplateParameterSource.ADMIN_DHIS2_USER_ID)
              ]
        - toD:
            description: Fetches the draft metadata import from the target DHIS2 data store.
            uri: dhis2:get/resource
            parameters:
              path: dataStore/org-unit-sync/${variables.dataStoreKey}
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - convertBodyTo:
            description: Converts the stream into a string.
            type: String
        - toD:
            description: Synchronise the resource on the target server.
            uri: direct:${variables.target['camelDirectEndpointName']}
        - setBody:
            description: Removes any left-over data in the body before creating a HTTP request.
            simple: ${null}
        - toD:
            description: | 
              Deletes the draft metadata import from the target DHIS2 data store to avoid the synchronisation from being 
              accidentally re-approved.
            uri: dhis2:delete/resource
            parameters:
              path: dataStore/org-unit-sync/${variables.dataStoreKey}
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}

- route:
    id: sendSyncApprovalRequestRoute
    description: |
      Saves the draft metadata import in the target DHIS2 data store and opens a ticket for approving the 
      synchronisation.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:sendSyncApprovalRequest
      steps:
        - setVariable:
            description: Sets a variable to a generated UUID that identifies the data store entry in the target DHIS2 server.
            name: dataStoreKey
            simple: ${uuid}
        - toD:
            description: Creates or updates the data store entry with the draft metadata import.
            uri: dhis2:put/resource
            parameters:
              path: dataStore/org-unit-sync/${variables.dataStoreKey}
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - to:
            description: Encrypts the query params for the approval link and stashes them inside a variable.
            uri: direct:encryptQueryParams
            variableReceive: dataQueryParam
        - setVariable:
            description: | 
              Sets a variable to the app's user-defined base URL. If the user has not specified a base URL, then it 
              attempts to resolve the base URL itself.
            name: approveUrl
            groovy: >
              camelContext.propertiesComponent.resolveProperty('approve.url').orElse('http://' + org.apache.camel.util.InetAddressUtil.getLocalHostNameSafe() + ':' + {{camel.server.port}})
        - to:
            description: Materialises a template to create the ticket body.
            uri: freemarker:templates/ticketBody.ftl
        - setHeader:
            description: Sets the ticket subject.
            name: CamelDhis2.queryParams
            groovy: "['subject': '[Org Unit Sync App] Approval Request']"
        - toD:
            description: Opens a ticket on the DHIS2 target server.
            uri: dhis2:post/resource
            parameters:
              path: messageConversations/feedback
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - unmarshal:
            description: Deserialises the JSON resource into a `java.util.Map`.
            json: { }
        - choice:
            when:
              - simple: "${body['status']} != 'SUCCESS' && ${body['status']}  != 'OK'"
                description: |
                  Executes the condition when the target returns an error. Compatible with older versions of DHIS2.
                steps:
                  - log:
                      loggingLevel: ERROR
                      message: "Error while sending approval request for resource [${variables.id}] to target server [${variables.target['dhis2ApiUrl']}]: ${body}"
            otherwise:
              steps:
                - log: Sent approval request for syncing resource [${variables.id}] to target server [${variables.target['dhis2ApiUrl']}]

- route:
    id: encryptQueryParamsRoute
    description: Encrypts and Base64 encodes the approval link query params that will be included in the ticket.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:encryptQueryParams
      steps:
        - setBody:
            description: Concatenates all the query params to be present in the approval link.
            simple: >
              dataStoreKey=${variables.dataStoreKey}&targetIndex=${variables.target['index']}&resourceId=${variables.id}&DebeziumOperation=${headers.DebeziumOperation}&DebeziumDiff=${headers.DebeziumDiff}&DebeziumSourceTable=${headers.DebeziumSourceTable}
        - marshal:
            description: Encrypts the query params.
            custom:
              ref: cryptoDataFormat
        - marshal:
            description: Base64 encodes the encrypted query params.
            base64:
              urlSafe: true
              lineSeparator: ":"
        - convertBodyTo:
            description: Converts the Base64 stream into a string.
            type: String

- route:
    id: decryptQueryParamsRoute
    description: Base64 decodes and decrypts the approval link query params.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:decryptQueryParams
      steps:
        - setBody:
            description: Sets the body to the encrypted value contained within the `data` query param.
            simple: ${headers.data}
        - unmarshal:
            description: Base64 decodes the encrypted query params.
            base64:
              lineSeparator: ":"
        - unmarshal:
            description: Decrypts the query params.
            custom:
              ref: cryptoDataFormat
        - convertBodyTo:
            description: Converts the binary stream into a string.
            type: String
        - transform:
            description: Splits the query params before adding them as headers.
            groovy: |
              body.split('&').each { q ->
                request.setHeader(q.take(q.indexOf('=')), q.drop(q.indexOf('=') + 1))
              }
