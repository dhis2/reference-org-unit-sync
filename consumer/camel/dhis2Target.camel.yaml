- route:
    id: dhis2TargetRoute
    description: |
      Routes the metadata payload to the route that will execute the synchronisation operation on the target server.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:dhis2Target
      steps:
        - log: "Syncing resource [${variables.id}]..."
        - choice:
            when:
              - simple: ${headers.DebeziumOperation} == 'd' && ${headers.DebeziumSourceTable} == 'organisationunit'
                description: |
                  Routes the message to the route that deletes the organisation unit when the Debezium operation is a 
                  delete and the table where the operation happened is "organisationunit".
                steps:
                  - to: direct:deleteOrgUnit
            otherwise:
              description: Routes the message to the route that imports the metadata resource.
              steps:
                - to: direct:importMetadata

- route:
    id: importMetadataRoute
    description: Imports metadata to the target server.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:importMetadata
      steps:
        - setHeader:
            description: Sets the HTTP query params for the DHIS2 request.
            name: CamelDhis2.queryParams
            groovy: "['importStrategy': 'CREATE_AND_UPDATE', 'idScheme': variables.target.idScheme]"
        - toD:
            description: Transmits a request to the target DHIS2 server to import the metadata.
            uri: dhis2:post/resource
            parameters:
              path: metadata
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - removeHeader:
            description: |
              Removes the HTTP query params from the previous request so that it does not interfere with any subsequent
              HTTP requests .
            name: CamelDhis2.queryParams
        - unmarshal:
            description: Deserialises the JSON resource into a `java.util.Map`.
            json: { }
        - choice:
            when:
              - simple: "${body['status']} == 'SUCCESS' || ${body['status']}  == 'OK'"
                description: |
                  Executes the condition when the target imports the metadata successfully. Compatible with older 
                  versions of DHIS2.
                steps:
                  - log: Successfully synced resource [${variables.id}] with target server [${variables.target['dhis2ApiUrl']}]
                  - to: direct:reportSuccess
            otherwise:
              steps:
                - to:
                    description: Notifies target DHIS2 user of a failed synchronisation.
                    uri: direct:reportFailure
                - throwException:
                    description: |
                      Forces an exception so that the failed synchronisation is pushed into a dead-letter queue.
                    message: "Error while syncing resource [${variables.id}] with target server [${variables.target['dhis2ApiUrl']}]: ${body}"
                    exceptionType: java.lang.Exception

- route:
    id: deleteOrgUnitRoute
    description: Deletes an org unit on the target server.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:deleteOrgUnit
      steps:
        - doTry:
            steps:
              - toD:
                  description: Transmits a request to the target to delete the org unit.
                  uri: dhis2:delete/resource
                  parameters:
                    path: "organisationUnits/${variables.id}"
                    baseApiUrl: ${variables.target['dhis2ApiUrl']}
                    username: ${variables.target['dhis2ApiUsername']}
                    password: ${variables.target['dhis2ApiPassword']}
                    personalAccessToken: ${variables.target['personalAccessToken']}
              - log: Synced deleted org unit [${variables.id}] with target server [${variables.target['dhis2ApiUrl']}]
              - to:
                  description: Notifies target DHIS2 user of successful synchronisation.
                  uri: direct:reportSuccess
              - doCatch:
                  exception:
                    - org.hisp.dhis.integration.sdk.api.RemoteDhis2ClientException
                  onWhen:
                    simple: ${exception.cause.httpStatusCode} == 404
                  steps:
                    - log:
                        loggingLevel: ERROR
                        message: Deleted org unit [${variables.id}] not found on target server [${variables.target['dhis2ApiUrl']}]

- route:
    id: reportSuccessRoute
    description: |
      Transmits a message to a user's inbox in the target DHIS2 server notifying them that a synchronisation succeeded. 
      The DHIS2 user recipient is set from the `target.[n].messageConversationUserId` property.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:reportSuccess
      steps:
        - to:
            description: Materialises a template to create the success message.
            uri: freemarker:templates/messageBodySuccess.json.ftl
        - toD:
            description: Creates a message conversation containing the success message on the target DHIS2 server.
            uri: dhis2:post/resource
            parameters:
              path: messageConversations
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - unmarshal:
            description: Deserialises the JSON resource into a `java.util.Map`.
            json: { }
        - choice:
            when:
              - simple: "${body['status']} != 'SUCCESS' && ${body['status']}  != 'OK'"
                description: |
                  Executes the condition when the target returns an error. Compatible with older versions of DHIS2.
                steps:
                  - log:
                      loggingLevel: ERROR
                      message: "Error while reporting successful sync for resource [${variables.id}] to target server [${variables.target['dhis2ApiUrl']}]: ${body}"

- route:
    id: reportFailureRoute
    description: |
      Transmits a message to a user's inbox in the target DHIS2 server notifying them that a synchronisation failed. The
      DHIS2 user recipient is set from the `target.[n].messageConversationUserId` property.
    routeConfigurationId: deadLetterQueueRouteConfig
    from:
      uri: direct:reportFailure
      steps:
        - to:
            description: Materialises a template to create the failure message.
            uri: freemarker:templates/messageBodyFailure.json.ftl
        - toD:
            description: Creates a message conversation containing the failure message on the target DHIS2 server.
            uri: dhis2:post/resource
            parameters:
              path: messageConversations
              baseApiUrl: ${variables.target['dhis2ApiUrl']}
              username: ${variables.target['dhis2ApiUsername']}
              password: ${variables.target['dhis2ApiPassword']}
              personalAccessToken: ${variables.target['personalAccessToken']}
        - unmarshal:
            description: Deserialises the JSON resource into a `java.util.Map`.
            json: { }
        - choice:
            when:
              - simple: "${body['status']} != 'SUCCESS' && ${body['status']}  != 'OK'"
                description: |
                  Executes the condition when the target returns an error. Compatible with older versions of DHIS2.
                steps:
                  - log:
                      loggingLevel: ERROR
                      message: "Error while reporting failure sync for resource [${variables.id}] to target server [${variables.target['dhis2ApiUrl']}]: ${body}"